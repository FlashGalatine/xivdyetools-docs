# OPT-002: Budget Find Fetches ALL Dye Prices Before Filtering

## Impact
MEDIUM

## Category
Algorithm / I/O Optimization

## Location
- File: src/services/budget/budget-calculator.ts
- Function: findCheaperAlternatives() (lines 78-209)

## Current Performance
The budget calculator:
1. Gets ALL non-Facewear dyes (~136 dyes)
2. Fetches prices for ALL 136 dyes via `fetchWithCache` (potentially 2 batches of API calls)
3. THEN filters by color distance, price, etc.

Most dyes will be eliminated by the color distance filter (default max distance = 50), meaning price data was fetched for dyes that are too color-different to be alternatives.

## Bottleneck Analysis
On cold cache, `fetchWithCache` makes 2 API calls (136 items / 100 per batch = 2 batches). Each API call to Universalis takes 200-500ms. With warm cache, it's ~136 individual Cache API lookups.

A typical search might only have 10-20 dyes within the color distance threshold, meaning 85%+ of fetched prices are unused.

## Proposed Optimization
Pre-filter dyes by color distance BEFORE fetching prices:

```typescript
// 1. Get all dyes
const allDyes = dyeService.getAllDyes().filter(dye => dye.itemID > 0);

// 2. Pre-filter by color distance (fast, CPU-only)
const candidates = allDyes.filter(dye => {
  if (dye.itemID === targetDyeId) return true; // Include target
  return ColorService.getColorDistance(targetDye.hex, dye.hex) <= maxDistance;
});

// 3. Fetch prices only for candidates (typically 10-30 instead of 136)
const itemIds = candidates.map(dye => dye.itemID);
const { prices } = await fetchWithCache(world, itemIds, fetchFn, logger);
```

## Expected Improvement
- API calls: from 2 batches to typically 1 batch (or even all from cache)
- Universalis proxy load: reduced by ~70-85%
- Command latency: reduced by 200-500ms on cold cache

## Trade-offs
- `ColorService.getColorDistance()` is called for all 136 dyes upfront (CPU cost)
- Color distance calculation is fast (~1μs per dye = ~136μs total), far cheaper than network I/O
- We must still fetch the target dye's price (always needed for comparison)

## Benchmark Approach
- Log `fromCache` and `fromApi` counts before/after
- Measure end-to-end budget command latency
